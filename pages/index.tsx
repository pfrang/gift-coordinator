import { useSession } from 'next-auth/react'
import Head from 'next/head'
import { useRouter } from 'next/router'
import { useEffect, useState } from 'react'
import mongoDB from '../sql-nodejs/cosmosdb/app'
import { removeDuplicateObjectsInArray } from '../utils/removeDuplicateObjectInArray'
import Button from './components/Buttons/Button'
import HowItWorks from './components/HowItWorks'


export const Home = (props) => {

  const [userData, setUserData] = useState()
  const [createdLobbies, setCreatedLobbies] = useState([])
  const [belongingLobbies, setBelongingLobbies] = useState([])
  const router = useRouter();
  const db = new mongoDB
  const { data: session, status } = useSession()

  useEffect(() => {
    if (status === 'authenticated') {
      const dbResponse = async () => {
        const query = `SELECT * from c where c.creator = '${session.user.email}'`;
        const response = await db.read(query).then((data) => data.resources);
        setCreatedLobbies(response);
        const query2 = `SELECT c.id FROM c JOIN t in c.users WHERE t.email = '${session.user.email}'`;
        const response2 = await db.read(query2).then((data) => removeDuplicateObjectsInArray(data.resources));
        setBelongingLobbies(response2);

      }
      dbResponse()
    }
  }, [status, db, session])

  const onClick = (e) => {
    router.push("/create")
  }
  return (
    <>
      <Head>
        <title>Gavekoordinator</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/gift-icon.ico" />
      </Head>
      <div className='flex flex-col relative items-center text-center h-full'>
        <div className='my-20'>
          <h2 className='text-3xl'>Opprett ønskelister på en felles platform og koordiner innkjøp!</h2>
          <h2 className='text-2xl my-4'>Hvordan fungerer det?</h2>
          <HowItWorks />
        </div>
        <div className='my-20'>
          <div className='border-2 shadow-md flex items-center gap-10'>
            <h2 className='text-2xl'>Opprett lobby her</h2>
            <Button onClick={onClick} text={'Create ->'} />
          </div>
        </div>
      </div>
    </>
  )
}

export default Home
